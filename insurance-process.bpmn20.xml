<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC" xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI" targetNamespace="http://www.flowable.org/processdef">

  <collaboration id="Collaboration_1">
    <participant id="Participant_GET" name="GET /api/workflow/client - Récupération infos client" processRef="getClientWorkflow" />
    <participant id="Participant_POST" name="POST /api/workflow/claim - Soumission réclamation" processRef="postClaimWorkflow" />
  </collaboration>

  <!-- ==================== WORKFLOW GET ==================== -->
  <process id="getClientWorkflow" name="GET /api/workflow/client" isExecutable="false">
    <laneSet id="LaneSet_GET">
      <lane id="Lane_GET" name="GET Workflow" />
    </laneSet>

    <startEvent id="get_start" name="Frontend&#10;GET Request" />
    <serviceTask id="get_rest" name="REST&#10;Vérifier Identité&#10;(Port 8080)" />
    <exclusiveGateway id="get_identity_gw" name="Identité&#10;Valide ?" />
    <serviceTask id="get_soap" name="SOAP&#10;Vérifier Police&#10;(Port 8081)" />
    <exclusiveGateway id="get_policy_gw" name="Police&#10;Valide ?" />
    <serviceTask id="get_graphql" name="GraphQL&#10;Récupérer Client&#10;(Port 4000)" />
    <dataStoreReference id="get_mongo" name="MongoDB&#10;(Claims DB)" />
    <endEvent id="get_success" name="Retour Client&#10;(Infos + Historique)" />
    <endEvent id="get_reject_id" name="Erreur 400&#10;Identité Invalide" />
    <endEvent id="get_reject_pol" name="Erreur 400&#10;Police Invalide" />

    <sequenceFlow id="get_f1" sourceRef="get_start" targetRef="get_rest" />
    <sequenceFlow id="get_f2" sourceRef="get_rest" targetRef="get_identity_gw" />
    <sequenceFlow id="get_f3" name="Oui" sourceRef="get_identity_gw" targetRef="get_soap" />
    <sequenceFlow id="get_f4" name="Non" sourceRef="get_identity_gw" targetRef="get_reject_id" />
    <sequenceFlow id="get_f5" sourceRef="get_soap" targetRef="get_policy_gw" />
    <sequenceFlow id="get_f6" name="Oui" sourceRef="get_policy_gw" targetRef="get_graphql" />
    <sequenceFlow id="get_f7" name="Non" sourceRef="get_policy_gw" targetRef="get_reject_pol" />
    <sequenceFlow id="get_f8" sourceRef="get_graphql" targetRef="get_success" />

    <dataOutputAssociation id="get_data_assoc">
      <sourceRef>get_graphql</sourceRef>
      <targetRef>get_mongo</targetRef>
    </dataOutputAssociation>
  </process>

  <!-- ==================== WORKFLOW POST ==================== -->
  <process id="postClaimWorkflow" name="POST /api/workflow/claim" isExecutable="false">
    <laneSet id="LaneSet_POST">
      <lane id="Lane_POST" name="POST Workflow" />
    </laneSet>

    <startEvent id="post_start" name="Frontend&#10;POST Request" />
    <serviceTask id="post_rest" name="REST&#10;Vérifier Identité&#10;(Port 8080)" />
    <exclusiveGateway id="post_identity_gw" name="Identité&#10;Valide ?" />
    <serviceTask id="post_soap" name="SOAP&#10;Vérifier Police&#10;(Port 8081)" />
    <exclusiveGateway id="post_policy_gw" name="Police&#10;Valide ?" />
    <serviceTask id="post_grpc" name="gRPC&#10;Détection Fraude&#10;(Port 50051)" />
    <serviceTask id="post_graphql" name="GraphQL&#10;Stocker Réclamation&#10;(Port 4000)" />
    <dataStoreReference id="post_mongo" name="MongoDB&#10;(Claims DB)" />
    <endEvent id="post_success" name="Retour Client&#10;(Réclamation créée)" />
    <endEvent id="post_reject_id" name="Erreur 400&#10;Identité Invalide" />
    <endEvent id="post_reject_pol" name="Erreur 400&#10;Police Invalide" />

    <sequenceFlow id="post_f1" sourceRef="post_start" targetRef="post_rest" />
    <sequenceFlow id="post_f2" sourceRef="post_rest" targetRef="post_identity_gw" />
    <sequenceFlow id="post_f3" name="Oui" sourceRef="post_identity_gw" targetRef="post_soap" />
    <sequenceFlow id="post_f4" name="Non" sourceRef="post_identity_gw" targetRef="post_reject_id" />
    <sequenceFlow id="post_f5" sourceRef="post_soap" targetRef="post_policy_gw" />
    <sequenceFlow id="post_f6" name="Oui" sourceRef="post_policy_gw" targetRef="post_grpc" />
    <sequenceFlow id="post_f7" name="Non" sourceRef="post_policy_gw" targetRef="post_reject_pol" />
    <sequenceFlow id="post_f8" sourceRef="post_grpc" targetRef="post_graphql" />
    <sequenceFlow id="post_f9" sourceRef="post_graphql" targetRef="post_success" />

    <dataOutputAssociation id="post_data_assoc">
      <sourceRef>post_graphql</sourceRef>
      <targetRef>post_mongo</targetRef>
    </dataOutputAssociation>
  </process>

  <!-- ==================== DIAGRAMME VISUEL ==================== -->
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Collaboration_1">

      <!-- ========== POOL GET ========== -->
      <bpmndi:BPMNShape id="Participant_GET_di" bpmnElement="Participant_GET" isHorizontal="true">
        <omgdc:Bounds x="120" y="60" width="1100" height="250" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="get_start_di" bpmnElement="get_start">
        <omgdc:Bounds x="180" y="152" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="164" y="195" width="68" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="get_rest_di" bpmnElement="get_rest">
        <omgdc:Bounds x="270" y="130" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="get_identity_gw_di" bpmnElement="get_identity_gw" isMarkerVisible="true">
        <omgdc:Bounds x="415" y="145" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="413" y="108" width="54" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="get_soap_di" bpmnElement="get_soap">
        <omgdc:Bounds x="510" y="130" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="get_policy_gw_di" bpmnElement="get_policy_gw" isMarkerVisible="true">
        <omgdc:Bounds x="655" y="145" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="656" y="108" width="48" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="get_graphql_di" bpmnElement="get_graphql">
        <omgdc:Bounds x="750" y="130" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="get_mongo_di" bpmnElement="get_mongo">
        <omgdc:Bounds x="895" y="145" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="885" y="202" width="70" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="get_success_di" bpmnElement="get_success">
        <omgdc:Bounds x="1002" y="152" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="978" y="195" width="84" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="get_reject_id_di" bpmnElement="get_reject_id">
        <omgdc:Bounds x="422" y="252" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="403" y="295" width="74" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="get_reject_pol_di" bpmnElement="get_reject_pol">
        <omgdc:Bounds x="662" y="252" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="646" y="295" width="68" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Edges GET -->
      <bpmndi:BPMNEdge id="get_f1_di" bpmnElement="get_f1">
        <omgdi:waypoint x="216" y="170" />
        <omgdi:waypoint x="270" y="170" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="get_f2_di" bpmnElement="get_f2">
        <omgdi:waypoint x="370" y="170" />
        <omgdi:waypoint x="415" y="170" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="get_f3_di" bpmnElement="get_f3">
        <omgdi:waypoint x="465" y="170" />
        <omgdi:waypoint x="510" y="170" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="479" y="152" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="get_f4_di" bpmnElement="get_f4">
        <omgdi:waypoint x="440" y="195" />
        <omgdi:waypoint x="440" y="252" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="447" y="213" width="21" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="get_f5_di" bpmnElement="get_f5">
        <omgdi:waypoint x="610" y="170" />
        <omgdi:waypoint x="655" y="170" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="get_f6_di" bpmnElement="get_f6">
        <omgdi:waypoint x="705" y="170" />
        <omgdi:waypoint x="750" y="170" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="719" y="152" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="get_f7_di" bpmnElement="get_f7">
        <omgdi:waypoint x="680" y="195" />
        <omgdi:waypoint x="680" y="252" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="687" y="213" width="21" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="get_f8_di" bpmnElement="get_f8">
        <omgdi:waypoint x="850" y="170" />
        <omgdi:waypoint x="895" y="170" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="get_mongo_edge" bpmnElement="get_f8">
        <omgdi:waypoint x="945" y="170" />
        <omgdi:waypoint x="1002" y="170" />
      </bpmndi:BPMNEdge>

      <!-- Association GraphQL -> MongoDB GET -->
      <bpmndi:BPMNEdge id="get_data_assoc_di">
        <omgdi:waypoint x="850" y="170" />
        <omgdi:waypoint x="895" y="170" />
      </bpmndi:BPMNEdge>

      <!-- ========== POOL POST ========== -->
      <bpmndi:BPMNShape id="Participant_POST_di" bpmnElement="Participant_POST" isHorizontal="true">
        <omgdc:Bounds x="120" y="350" width="1220" height="250" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_start_di" bpmnElement="post_start">
        <omgdc:Bounds x="180" y="442" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="162" y="485" width="72" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_rest_di" bpmnElement="post_rest">
        <omgdc:Bounds x="270" y="420" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_identity_gw_di" bpmnElement="post_identity_gw" isMarkerVisible="true">
        <omgdc:Bounds x="415" y="435" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="413" y="398" width="54" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_soap_di" bpmnElement="post_soap">
        <omgdc:Bounds x="510" y="420" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_policy_gw_di" bpmnElement="post_policy_gw" isMarkerVisible="true">
        <omgdc:Bounds x="655" y="435" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="656" y="398" width="48" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_grpc_di" bpmnElement="post_grpc">
        <omgdc:Bounds x="750" y="420" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_graphql_di" bpmnElement="post_graphql">
        <omgdc:Bounds x="900" y="420" width="100" height="80" />
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_mongo_di" bpmnElement="post_mongo">
        <omgdc:Bounds x="1045" y="435" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="1035" y="492" width="70" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_success_di" bpmnElement="post_success">
        <omgdc:Bounds x="1152" y="442" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="1127" y="485" width="86" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_reject_id_di" bpmnElement="post_reject_id">
        <omgdc:Bounds x="422" y="542" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="403" y="585" width="74" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <bpmndi:BPMNShape id="post_reject_pol_di" bpmnElement="post_reject_pol">
        <omgdc:Bounds x="662" y="542" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="646" y="585" width="68" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>

      <!-- Edges POST -->
      <bpmndi:BPMNEdge id="post_f1_di" bpmnElement="post_f1">
        <omgdi:waypoint x="216" y="460" />
        <omgdi:waypoint x="270" y="460" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="post_f2_di" bpmnElement="post_f2">
        <omgdi:waypoint x="370" y="460" />
        <omgdi:waypoint x="415" y="460" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="post_f3_di" bpmnElement="post_f3">
        <omgdi:waypoint x="465" y="460" />
        <omgdi:waypoint x="510" y="460" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="479" y="442" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="post_f4_di" bpmnElement="post_f4">
        <omgdi:waypoint x="440" y="485" />
        <omgdi:waypoint x="440" y="542" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="447" y="503" width="21" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="post_f5_di" bpmnElement="post_f5">
        <omgdi:waypoint x="610" y="460" />
        <omgdi:waypoint x="655" y="460" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="post_f6_di" bpmnElement="post_f6">
        <omgdi:waypoint x="705" y="460" />
        <omgdi:waypoint x="750" y="460" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="719" y="442" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="post_f7_di" bpmnElement="post_f7">
        <omgdi:waypoint x="680" y="485" />
        <omgdi:waypoint x="680" y="542" />
        <bpmndi:BPMNLabel>
          <omgdc:Bounds x="687" y="503" width="21" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="post_f8_di" bpmnElement="post_f8">
        <omgdi:waypoint x="850" y="460" />
        <omgdi:waypoint x="900" y="460" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="post_f9_di" bpmnElement="post_f9">
        <omgdi:waypoint x="1000" y="460" />
        <omgdi:waypoint x="1045" y="460" />
      </bpmndi:BPMNEdge>

      <bpmndi:BPMNEdge id="post_mongo_edge">
        <omgdi:waypoint x="1095" y="460" />
        <omgdi:waypoint x="1152" y="460" />
      </bpmndi:BPMNEdge>

    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</definitions>
